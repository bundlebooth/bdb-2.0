<div id="iframe-messages" style="position: fixed; bottom: 20px; right: 20px; background: white; border: 1px solid #ccc; padding: 10px; max-width: 300px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
  <h4 style="margin-top: 0;">Iframe Messages</h4>
  <div id="message-log"></div>
  <button onclick="document.getElementById('iframe-messages').style.display = 'none'" style="margin-top: 10px;">Close</button>
</div>

<iframe 
  id="bundlebooth-iframe"
  src="https://bundlebooth.github.io/bdb-2.0/frontend/Step123_Iframe_test.html" 
  style="width: 100%; border: 0; display: block;" 
  scrolling="no"
  allowfullscreen>
</iframe>

<style>
  #bundlebooth-iframe {
    height: 2300px;
    transition: height 0.3s ease;
  }
  
  .message-entry {
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
    font-size: 12px;
  }
  
  .message-entry:last-child {
    border-bottom: none;
  }
  
  .message-time {
    color: #666;
    font-size: 10px;
  }
</style>

<script>
// Function to adjust iframe height
function adjustIframeHeight(height) {
  const iframe = document.getElementById('bundlebooth-iframe');
  if (iframe) {
    iframe.style.height = height + 'px';
    logMessage(`Iframe height adjusted to: ${height}px`);
  }
}

// Function to scroll to iframe
function scrollToIframe() {
  const iframe = document.getElementById('bundlebooth-iframe');
  if (iframe) {
    window.scrollTo({
      top: iframe.offsetTop - 20,
      behavior: 'smooth'
    });
    logMessage('Scrolled to iframe');
  }
}

// Function to log messages
function logMessage(message) {
  const messageLog = document.getElementById('message-log');
  if (messageLog) {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    const messageEntry = document.createElement('div');
    messageEntry.className = 'message-entry';
    messageEntry.innerHTML = `
      <div class="message-time">${timeString}</div>
      <div>${message}</div>
    `;
    messageLog.prepend(messageEntry);
    
    document.getElementById('iframe-messages').style.display = 'block';
  }
}

// Initial scroll when page loads
window.addEventListener('DOMContentLoaded', () => {
  scrollToIframe();
  logMessage('Page loaded, iframe initialized');
});

// Handle messages from iframe - COMPLETELY NEW VERSION
window.addEventListener('message', function(event) {
  // First check if this is a message from our iframe
  try {
    const iframe = document.getElementById('bundlebooth-iframe');
    if (!iframe || event.source !== iframe.contentWindow) {
      return; // Silently ignore messages not from our iframe
    }
    
    // Then verify the origin is either GitHub or your production domain
    const allowedOrigins = [
      'https://bundlebooth.github.io',
      'https://bundlebooth.ca'
    ];
    
    if (!allowedOrigins.includes(event.origin)) {
      return; // Silently ignore unauthorized messages
    }
    
    // Only process if data is an object with type property
    if (typeof event.data === 'object' && event.data.type) {
      logMessage(`Valid message from ${event.origin}: ${event.data.type}`);
      
      if (event.data.type === 'stepChanged') {
        logMessage(`Step changed to ${event.data.step}`);
        if (event.data.height) {
          adjustIframeHeight(event.data.height);
        }
        scrollToIframe();
      }
    }
  } catch (e) {
    console.error('Error processing message:', e);
  }
}, false);

// Add toggle button for messages panel
const toggleBtn = document.createElement('button');
toggleBtn.textContent = 'Show Messages';
toggleBtn.style.position = 'fixed';
toggleBtn.style.bottom = '20px';
toggleBtn.style.right = '20px';
toggleBtn.style.zIndex = '1001';
toggleBtn.onclick = function() {
  const panel = document.getElementById('iframe-messages');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
};
document.body.appendChild(toggleBtn);
</script>
